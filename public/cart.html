<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your Bag</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>body{font-family:'Inter',sans-serif;} .font-anton{font-family:'Anton',sans-serif;}</style>
</head>
<body class="bg-gray-50 text-black antialiased">

    <nav class="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md border-b border-gray-100">
        <div class="container mx-auto px-6 h-20 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-anton italic tracking-tighter hover:opacity-70 transition">PRO<span class="text-red-600">KICKS</span></a>
            <a href="index.html" class="text-xs font-bold uppercase text-gray-400 hover:text-black transition">Continue Shopping</a>
        </div>
    </nav>

    <div class="container mx-auto py-32 px-6 grid grid-cols-1 lg:grid-cols-12 gap-16">
        <div class="lg:col-span-7 order-2 lg:order-1">
            <div class="flex justify-between items-end mb-6">
                <h2 class="text-2xl font-black uppercase flex items-center gap-3">
                    <span class="bg-black text-white w-8 h-8 flex items-center justify-center rounded-full text-xs">1</span> Shipping
                </h2>
                <select id="addr-select" onchange="AddressMgr.fillForm(this.value)" class="text-xs border p-2 rounded bg-white cursor-pointer outline-none hover:border-black shadow-sm">
                    <option value="">Loading...</option>
                </select>
            </div>

            <form onsubmit="openConfirm(event)" class="space-y-6 bg-white p-8 rounded-lg shadow-sm border border-gray-100">
                <div class="grid grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold uppercase text-gray-400 block mb-2">Full Name</label>
                        <input id="c-name" class="w-full border-b-2 p-3 font-bold focus:border-black outline-none transition" placeholder="John Doe" required>
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold uppercase text-gray-400 block mb-2">Phone</label>
                        <input id="c-tel" class="w-full border-b-2 p-3 font-bold focus:border-black outline-none transition" placeholder="08X-XXX-XXXX" required>
                    </div>
                </div>
                <div>
                     <label class="text-[10px] font-bold uppercase text-gray-400 block mb-2">Address</label>
                     <textarea id="c-addr" class="w-full border-2 border-gray-100 p-4 font-medium h-32 focus:border-black rounded-lg outline-none transition resize-none" placeholder="Delivery Address..." required></textarea>
                </div>
                <div class="pt-8 border-t border-gray-100">
                    <h3 class="font-black uppercase text-sm mb-4">Payment (Bank Transfer)</h3>
                    <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-xs">KBANK</div>
                        <div><p class="font-bold text-sm">Kasikorn Bank</p><p class="text-xs text-gray-500 font-mono">123-4-56789-0 (ProKicks)</p></div>
                    </div>
                    <input id="c-slip" class="w-full border-b-2 p-3 font-bold text-sm focus:border-black outline-none transition" placeholder="Paste Slip Image URL here..." required>
                </div>
                <button type="submit" class="w-full bg-black text-white py-5 font-black uppercase tracking-widest text-sm hover:bg-green-600 transition shadow-lg rounded-lg">Review Order</button>
            </form>
        </div>

        <div class="lg:col-span-5 order-1 lg:order-2">
            <div class="bg-white p-8 rounded-lg shadow-xl sticky top-28 border border-gray-100">
                <h2 class="font-black uppercase mb-8 pb-4 border-b border-gray-100 flex justify-between items-center text-lg">Your Bag</h2>
                <div id="c-items" class="space-y-6 mb-8 max-h-[400px] overflow-y-auto pr-2"></div>
                <div class="border-t border-dashed border-gray-300 pt-6 flex justify-between items-end">
                    <span class="text-sm font-bold uppercase text-black">Total</span>
                    <span id="total-price" class="text-4xl font-anton tracking-tighter">฿0</span>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 transform scale-100 transition-all">
            <div class="text-center mb-6">
                <h3 class="text-xl font-black uppercase mb-2">Confirm Order?</h3>
                <p class="text-sm text-gray-500 px-4">Address details will be saved for next time.</p>
            </div>
            <div class="space-y-3">
                <button onclick="processOrder()" class="w-full bg-black text-white py-3 rounded-lg font-bold uppercase hover:bg-green-600 transition">Yes, Place Order</button>
                <button onclick="closeModal('confirm-modal')" class="w-full bg-gray-100 text-gray-500 py-3 rounded-lg font-bold uppercase hover:bg-gray-200 transition">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="script.js"></script>
    <script>
        // Inline Script for Cart Page
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const container = document.getElementById('c-items');
        let total = 0;

        if (cart.length === 0) {
            container.innerHTML = '<div class="text-center py-10"><p class="text-gray-300 font-black uppercase text-4xl mb-2">Empty</p></div>';
            document.querySelector('button[type="submit"]').disabled = true;
            document.querySelector('button[type="submit"]').classList.add('opacity-50');
        } else {
            container.innerHTML = cart.map((i, idx) => {
                total += i.price;
                return `
                <div class="flex gap-4 group border-b border-gray-50 pb-4 last:border-0">
                    <div class="w-16 h-16 bg-gray-50 border rounded p-1 flex-shrink-0">
                        <img src="${i.image}" class="w-full h-full object-contain">
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <h4 class="font-bold text-sm uppercase line-clamp-1 pr-2">${i.name}</h4>
                            <button onclick="removeItem(${idx})" class="text-[10px] font-bold text-red-400 uppercase hover:text-red-600">Remove</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Size: <span class="text-black font-bold">${i.size}</span></p>
                        <p class="font-mono font-bold text-sm mt-1">${money(i.price)}</p>
                    </div>
                </div>`;
            }).join('');
        }
        document.getElementById('total-price').innerText = money(total);

        function removeItem(idx) {
            cart.splice(idx, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            location.reload();
        }

        function openConfirm(e) {
            e.preventDefault();
            if(!localStorage.getItem('token')) return showToast('Please Login First', 'error'), setTimeout(()=>location.href='login.html', 1000);
            openModal('confirm-modal');
        }

        async function processOrder() {
            // เรียกฟังก์ชันกลางใน script.js (ต้องปรับให้รับค่าหรือเรียก finalSubmit)
            // แต่เพื่อความง่าย เราใช้ Logic ตรงนี้เลยก็ได้ หรือเรียก finalSubmit จาก script.js
            // ในที่นี้ผมขอเรียก finalSubmit ที่เราเตรียมไว้ใน script.js (แต่ต้องแก้ชื่อฟังก์ชันใน script.js ให้ตรงกัน หรือเขียนใหม่ที่นี่)
            
            // เพื่อความชัวร์ ใช้ Logic เดียวกับที่ให้ไปใน script.js โดยการก๊อปปี้ฟังก์ชัน finalSubmit มาใส่ใน script.js หลัก
            // (ในไฟล์ script.js ที่ให้ไปข้างบน ผมไม่ได้ใส่ finalSubmit ไว้เพื่อลดความซ้ำซ้อน แต่ถ้าคุณต้องการเรียกใช้ ให้เพิ่มโค้ดนี้ลงไปใน script.js หรือในแท็กนี้)
            
            // เรียกฟังก์ชัน global ที่เราจะไปเพิ่มใน script.js (ดูข้างล่าง)
            await submitOrderAction(); 
        }

        // เพิ่มฟังก์ชันนี้ใน script.js หรือใช้ตรงนี้
        async function submitOrderAction() {
             const btn = document.querySelector('#confirm-modal button');
             btn.innerText = "Processing..."; btn.disabled = true;
             
             const name = document.getElementById('c-name').value;
             const tel = document.getElementById('c-tel').value;
             const addr = document.getElementById('c-addr').value;
             const slip = document.getElementById('c-slip').value;
             
             AddressMgr.save(name, tel, addr);

             try {
                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        customerName: name, tel, address: addr, slipImage: slip,
                        totalPrice: total,
                        items: cart.map(i => ({ productName: i.name, size: i.size, price: i.price, qty: 1 }))
                    })
                });
                if(res.ok) {
                    localStorage.removeItem('cart');
                    document.querySelector('#confirm-modal > div').innerHTML = `<div class="text-center py-6"><h3 class="text-xl font-black mb-2 text-green-600">Order Success!</h3><p>Redirecting...</p></div>`;
                    setTimeout(() => window.location.href = 'index.html', 2000);
                } else throw new Error('Failed');
             } catch(e) {
                showToast('Order Failed', 'error');
                closeModal('confirm-modal');
                btn.innerText = "Yes, Place Order"; btn.disabled = false;
             }
        }
    </script>
</body>
</html>